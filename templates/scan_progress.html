{% extends "base.html" %}

{% block title %}Scan Progress - NOA SQL Scanner{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-spinner fa-spin"></i> Scan in Progress</h1>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-crosshairs"></i> Target: 
            <span id="target-url">{{ scan_info.target_url if scan_info else 'Loading...' }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <h6>Scan Progress</h6>
            <div class="progress" style="height: 30px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <p id="progress-message" class="text-muted mt-2">Initializing scan...</p>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="urls-found">0</h4>
                        <small>URLs Found</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="urls-scanned">0</h4>
                        <small>URLs Scanned</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="vulns-found" class="text-danger">0</h4>
                        <small>Vulnerabilities Found</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="subdomains-section" style="display: none;">
            <h6><i class="fas fa-sitemap"></i> Discovered Subdomains</h6>
            <div id="subdomains-list" class="alert alert-info">
                <small>Loading...</small>
            </div>
        </div>
        
        <div id="vulnerabilities-section" style="display: none;">
            <h5 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Vulnerabilities Detected!</h5>
            <div id="vulnerabilities-list" class="list-group mb-3"></div>
        </div>
        
        <div id="scan-log" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
            <div id="log-content"></div>
        </div>
        
        <div class="mt-3">
            <button id="stop-scan" class="btn btn-danger" onclick="stopScan('{{ scan_id }}')">
                <i class="fas fa-stop"></i> Stop Scan
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-home"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const scanId = "{{ scan_id }}";
    let socket = null;
    
    // Initialize WebSocket
    function initWebSocket() {
        socket = io();
        
        socket.on('connect', function() {
            console.log('‚úì WebSocket connected');
            socket.emit('subscribe_scan', { scan_id: scanId });
            addLog('Connected to scan session', 'success');
        });
        
        socket.on('disconnect', function() {
            console.log('‚úó WebSocket disconnected');
            addLog('Disconnected from server', 'warning');
        });
        
        socket.on('subscribed', function(data) {
            console.log('‚úì Subscribed to scan:', data.scan_id);
        });
        
        // Progress updates
        socket.on('scan_progress', function(data) {
            if (data.scan_id === scanId) {
                console.log('Progress update:', data.progress + '%', data.message);
                updateProgress(data.progress, data.message);
            }
        });
        
        // Log messages (YENƒ∞!)
        socket.on('scan_log', function(data) {
            if (data.scan_id === scanId) {
                console.log('Log:', data.level, data.message);
                addLog(data.message, data.level);
                
                // Subdomain detection
                if (data.message.includes('Found subdomain:') || data.message.includes('‚úì Found subdomain:')) {
                    const subdomain = data.message.split(':')[1].trim();
                    addSubdomain(subdomain);
                }
            }
        });
        
        // Vulnerability found
        socket.on('vulnerability_found', function(data) {
            if (data.scan_id === scanId) {
                console.log('Vulnerability found:', data.vulnerability);
                addVulnerability(data.vulnerability);
                updateVulnCount();
                addLog('üö® VULNERABILITY FOUND!', 'danger');
            }
        });
        
        socket.on('error', function(error) {
            console.error('WebSocket error:', error);
            addLog('Connection error occurred', 'danger');
        });
    }
    
    // Update progress bar
    function updateProgress(percent, message) {
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        
        if (progressBar) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
            
            if (percent === 100) {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                
                const stopBtn = document.getElementById('stop-scan');
                if (stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-check"></i> Completed';
                }
            }
        }
        
        if (progressMessage) {
            progressMessage.textContent = message;
        }
    }
    
    // Add log entry
    function addLog(message, level = 'info') {
        const logContent = document.getElementById('log-content');
        if (!logContent) return;
        
        const timestamp = new Date().toLocaleTimeString();
        let colorClass = 'text-info';
        let icon = '‚ÑπÔ∏è';
        
        switch(level) {
            case 'danger':
            case 'error':
                colorClass = 'text-danger';
                icon = '‚ùå';
                break;
            case 'warning':
                colorClass = 'text-warning';
                icon = '‚ö†Ô∏è';
                break;
            case 'success':
                colorClass = 'text-success';
                icon = '‚úì';
                break;
            case 'info':
            default:
                colorClass = 'text-info';
                icon = '‚ÑπÔ∏è';
                break;
        }
        
        const logEntry = document.createElement('div');
        logEntry.className = colorClass;
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${icon} ${escapeHtml(message)}`;
        
        logContent.appendChild(logEntry);
        
        // Auto-scroll to bottom
        logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
    }
    
    // Add subdomain to display
    function addSubdomain(subdomain) {
        const section = document.getElementById('subdomains-section');
        const list = document.getElementById('subdomains-list');
        
        if (!section || !list) return;
        
        section.style.display = 'block';
        
        // Initialize or append
        if (list.innerHTML.includes('Loading...')) {
            list.innerHTML = '';
        }
        
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-1 mb-1';
        badge.textContent = subdomain;
        list.appendChild(badge);
    }
    
    // Add vulnerability to list
    function addVulnerability(vuln) {
        const section = document.getElementById('vulnerabilities-section');
        const list = document.getElementById('vulnerabilities-list');
        
        if (!section || !list) return;
        
        section.style.display = 'block';
        
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-danger';
        item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">
                    <i class="fas fa-bug"></i> ${escapeHtml(vuln.attack_type)} - ${escapeHtml(vuln.db_type)}
                </h6>
                <small>${new Date().toLocaleTimeString()}</small>
            </div>
            <p class="mb-1"><strong>URL:</strong> <code>${escapeHtml(vuln.url)}</code></p>
            <p class="mb-1"><strong>Parameter:</strong> <code>${escapeHtml(vuln.parameter)}</code></p>
            <small><strong>Payload:</strong> <code>${escapeHtml(vuln.payload)}</code></small>
        `;
        
        list.insertBefore(item, list.firstChild);
    }
    
    // Update vulnerability count
    function updateVulnCount() {
        const vulnCount = document.getElementById('vulns-found');
        if (!vulnCount) return;
        
        const count = document.querySelectorAll('#vulnerabilities-list .list-group-item').length;
        vulnCount.textContent = count;
        
        if (count > 0) {
            vulnCount.classList.add('text-danger', 'fw-bold');
        }
    }
    
    // Stop scan
    function stopScan(scanId) {
        if (!confirm('Are you sure you want to stop this scan?')) {
            return;
        }
        
        fetch(`/api/scan/stop/${scanId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            addLog('Scan stopped by user', 'warning');
            
            const stopBtn = document.getElementById('stop-scan');
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<i class="fas fa-ban"></i> Stopped';
            }
        })
        .catch(error => {
            console.error('Error stopping scan:', error);
            addLog('Failed to stop scan: ' + error, 'danger');
        });
    }
    
    // Poll for scan status
    function pollScanStatus() {
        setInterval(function() {
            fetch(`/api/scan/status/${scanId}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        // Update stats
                        const urlsFound = document.getElementById('urls-found');
                        const urlsScanned = document.getElementById('urls-scanned');
                        
                        if (urlsFound) urlsFound.textContent = data.urls_found || 0;
                        if (urlsScanned) urlsScanned.textContent = data.urls_scanned || 0;
                        
                        // Update progress if available
                        if (data.progress && data.progress > 0) {
                            updateProgress(data.progress, data.status || 'Processing...');
                        }
                        
                        // If scan is complete, redirect after 3 seconds
                        if (data.status === 'completed' && !sessionStorage.getItem('scan_complete_' + scanId)) {
                            sessionStorage.setItem('scan_complete_' + scanId, 'true');
                            addLog('Scan complete! Redirecting to report...', 'success');
                            setTimeout(function() {
                                window.location.href = `/report/${scanId}`;
                            }, 3000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error polling scan status:', error);
                });
        }, 3000); // Poll every 3 seconds
    }
    
    // Utility: Escape HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing scan progress page for:', scanId);
        addLog('Initializing scan...', 'info');
        
        // Start WebSocket
        initWebSocket();
        
        // Start polling
        pollScanStatus();
    });
</script>
{% endblock %}
```

## Test i√ßin: Console'da kontrol

Browser'ƒ±n DevTools Console'unda ≈üunlarƒ± g√∂rmelisin:
```
‚úì WebSocket connected
‚úì Subscribed to scan: xxxxx
Progress update: 5% Initializing scanner...
Log: info Starting scan for: https://example.com
