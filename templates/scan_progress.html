{% extends "base.html" %}

{% block title %}Scan Progress - NOA SQL Scanner{% endblock %}

{% block extra_js %}
<!-- Socket.IO önce yüklensin -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/scanner.js') }}"></script>
{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-spinner fa-spin"></i> Scan in Progress</h1>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-crosshairs"></i> Target: 
            <span id="target-url">{{ scan_info.target_url if scan_info else 'Loading...' }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <h6>Scan Progress</h6>
            <div class="progress" style="height: 30px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%">0%</div>
            </div>
            <p id="progress-message" class="text-muted mt-2">Initializing scan...</p>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="urls-found">0</h4>
                        <small>URLs Found</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="urls-scanned">0</h4>
                        <small>URLs Scanned</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 id="vulns-found" class="text-danger">0</h4>
                        <small>Vulnerabilities Found</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="vulnerabilities-section" style="display: none;">
            <h5 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Vulnerabilities Detected!</h5>
            <div id="vulnerabilities-list" class="list-group mb-3"></div>
        </div>
        
        <div id="scan-log" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace;">
            <div id="log-content"></div>
        </div>
        
        <div class="mt-3">
            <button id="stop-scan" class="btn btn-danger" onclick="stopScan('{{ scan_id }}')">
                <i class="fas fa-stop"></i> Stop Scan
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-home"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    // Page yüklendikten sonra WebSocket'i başlat
    document.addEventListener('DOMContentLoaded', function() {
        const scanId = "{{ scan_id }}";
        
        // WebSocket'i başlat
        initializeWebSocket(scanId);
        
        // Status polling'i başlat
        pollScanStatus(scanId);
        socket.on('scan_log', function(data) {
    if (data.scan_id === scanId) {
        addLog(data.message, data.level);
    }
    });
</script>
{% endblock %}
